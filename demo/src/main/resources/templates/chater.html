<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
</head>

<body>
<div class="container my-3">
    <div class="mb-3">
        <h3>채팅방</h3>
    </div>

    <!-- 메시지 영역 -->
    <div id="msgArea" class="mb-3"></div>

    <!-- 메시지 전송 입력 -->
    <div class="mb-3">
        <div class="input-group">
            <input type="text" id="msg" class="form-control" placeholder="메시지를 입력하세요">
            <button class="btn btn-outline-secondary" type="button" id="button-send">전송</button>
        </div>
    </div>

    <!-- 파일 업로드 폼 -->
    <div>
        <form id="fileUploadForm" enctype="multipart/form-data">
            <div class="input-group">
                <input type="file" class="form-control" id="file" name="file">
                <button class="btn btn-outline-secondary" type="button" id="button-upload">파일 업로드</button>
            </div>
            <div id="uploadMessage" class="mt-2"></div> <!-- 업로드 결과 메시지 -->
        </form>
    </div>
</div>

<script th:inline="javascript">
    $(document).ready(function(){

        const username = "userName";
        let websocket;

        // 웹소켓 연결 함수
        function createWebSocket() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                return;
            }
            websocket = new WebSocket("ws://localhost:8080/ws/chat");

            websocket.onmessage = onMessage;
            websocket.onopen = onOpen;
            websocket.onclose = onClose;

            console.log("New WebSocket connection established.");
        }

        createWebSocket();

        // 메시지 전송 버튼
        $("#button-send").on("click", () => {
            send();
        });

        // 파일 업로드 버튼
        $("#button-upload").on("click", () => {
            uploadFile();
        });

        function send(){
            const msg = document.getElementById("msg");
            if (msg.value.trim() === "") return;
            websocket.send(username + ":" + msg.value);
            msg.value = '';
        }

        function onClose(evt) {
            console.log("WebSocket connection closed.");
            if (websocket) {
                websocket = null;
            }
        }

        function onOpen(evt) {
            websocket.send(username + ": 님이 입장하셨습니다.");
            console.log("WebSocket connection opened.");
        }

        function onMessage(msg) {
            const data = msg.data;
            const [sessionId, message] = data.split(":");

            const isCurrentUser = (sessionId === username);
            const messageClass = isCurrentUser ? "alert-secondary" : "alert-warning";

            // 파일 메시지인 경우 링크로 표시
            const isFileMessage = message.startsWith("[파일] ");
            let messageHtml;

            if (isFileMessage) {
                const fileName = message.replace("[파일] ", "").trim();
                messageHtml = `<div class='alert ${messageClass} mb-2'><b>${sessionId}:</b> <a href="/uploads/${fileName}" target="_blank">${fileName}</a></div>`;
            } else {
                messageHtml = `<div class='alert ${messageClass} mb-2'><b>${sessionId} : ${message}</b></div>`;
            }

            $("#msgArea").append(messageHtml);
        }

        // 파일 업로드 함수
        function uploadFile() {
            const form = $('#fileUploadForm')[0];
            const data = new FormData(form);

            $.ajax({
                type: "POST",
                enctype: 'multipart/form-data',
                url: "/uploadFile",
                data: data,
                processData: false,
                contentType: false,
                cache: false,
                timeout: 600000,
                success: function (response) {
                    $('#uploadMessage').html("<div class='alert alert-success'>File uploaded successfully: " + response + "</div>");
                    console.log("파일 업로드 성공: " + response);
                    // 업로드 성공 시, 채팅방에 파일 메시지 전송
                    websocket.send(username + ": [파일] " + response);
                },
                error: function (e) {
                    $('#uploadMessage').html("<div class='alert alert-danger'>File upload failed: " + e.responseText + "</div>");
                    console.log("파일 업로드 실패: " + e.responseText);
                }
            });
        }
    });
</script>
</body>
</html>
